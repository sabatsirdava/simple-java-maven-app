// Pipeline Syntax: Declarative
pipeline {
    // Purpose of a Pipeline: Defines the entire CD process as code (Pipeline as Code)
    agent {
            label 'TEST_NODE' // Targets the specific node you just configured
        }

    tools {
            // This makes the configured tool available in the build environment
            allure 'Allure_CLI'
    }

    // Environment variables for reusable paths and properties
    environment {
        // Directory created by the Allure TestNG Listener
        ALLURE_RESULTS_DIR = 'allure-results'
        // File created in the API Tests stage to be archived/transferred
        API_SUMMARY_ARTIFACT = 'api_data_summary.txt' 
        // Build token for REST API remote trigger (for exam topic coverage)
        BUILD_AUTH_TOKEN = 'MY_AUTOMATION_TOKEN_123' 
    }

    // Build Triggers: Git changes hooks (Jenkins setup required later)
    triggers {
        // 1. Cron/Timer Trigger: Executes a build every day at 2:00 AM
        // Syntax: MIN HOUR DOM MON DOW
        cron '0 2 * * *'

        // 2. Poll SCM: The backup trigger to check Git for changes every 5 minutes
        pollSCM 'H/5 * * * *'
    }

    stages {
        // === Multi-stage Pipeline Stage 1: Build ===
        stage('Build & Dependencies') {
            steps {
                echo 'Cleaning and building project using Maven...'
                // Use the sh step for Linux/Unix agents, or bat for Windows
                bat 'mvn clean install -DskipTests'
            }
        }

        // === Multi-stage Pipeline Stage 2: API Tests ===
        stage('API Tests & Artifact Creation') {
            when {
                expression { return params.TEST_GROUP == 'api' }
            }
            steps {
                echo "Running API Tests using parameter: ${params.TEST_GROUP}..."
                echo "DEBUG: Current branch name is: ${env.BRANCH_NAME}"
                echo "DEBUG: Another possible branch name: ${env.GIT_BRANCH}"
                
                // Runs API tests by injecting the 'api' group into the pom.xml placeholder
                bat "mvn test -Dtest.groups=${params.TEST_GROUP}"
                // Saving Artifacts: Create a dummy artifact (Simulates RestAssured generating a payload/summary)
                bat "echo 'API Tests Run Count: 10, Success Rate: 90%' > ${API_SUMMARY_ARTIFACT}"

                bat "echo Verifying artifact existence in: ${WORKSPACE}/${API_SUMMARY_ARTIFACT}"
                
                // Logical Construct: Fail the build if the summary file wasn't created
                script {
                    if (fileExists(env.API_SUMMARY_ARTIFACT)) {
                        echo "API Summary Artifact created successfully."
                    } else {
                        error "Artifact missing! Failing the build."
                    }
                }
            }
        }

        // === Multi-stage Pipeline Stage 3: UI Tests ===
        stage('UI Tests (Integration)') {
                // FIX: Use an expression to check the reliable GIT_BRANCH variable
                when {
                    expression {
                         return (env.GIT_BRANCH == 'origin/master' || env.GIT_BRANCH == 'master') && (params.TEST_GROUP == 'ui')
                    }
                }
                steps {
                    echo "Running UI Tests using parameter: ${params.TEST_GROUP}..."

                    bat "mvn test -Dtest.groups=${params.TEST_GROUP}"
                }
            }
    }

    // Post-build actions: run cleanup and reporting regardless of stage success
    post {
        always {
            echo 'Archiving and Publishing Results...'
            
            // Publishing Artifacts: Saves the compiled JAR and the custom summary file
            archiveArtifacts artifacts: 'target/*.jar', fingerprint: true

            // 2. Archive the custom text file separately (explicit name)
            archiveArtifacts artifacts: 'api_data_summary.txt', fingerprint: true
            
            // Organizing and Accessing Auto Tests Results (Allure HTML Reporter)
            // Assumes Allure Jenkins Plugin is installed
            allure results: [
                [path: env.ALLURE_RESULTS_DIR]
            ]

            // Records TestNG results for Jenkins' built-in trending and status checks
            junit 'target/surefire-reports/*.xml'
        }
        
        // Logical Construct: Send notification only if the build succeeds
        success {

            echo 'Pipeline SUCCESS: All tests passed. Sending Email.'
            mail to: 'practice1112003@gmail.com',
                 subject: "✅ Pipeline SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "The test run passed. View Allure Report: ${env.BUILD_URL}allure/"
         }
        
         failure {
             echo 'Pipeline FAILURE: One or more tests failed. Sending Email.'
             mail to: 'practice1112003@gmail.com',
                  subject: "❌ Pipeline FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                  body: "One or more tests failed. Check the console output: ${env.BUILD_URL}console"
         }
    }
}
